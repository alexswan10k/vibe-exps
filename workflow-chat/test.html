<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Chat Test Page</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .test-scenarios {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .scenario-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .scenario-card h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        .scenario-card p {
            color: #666;
            margin-bottom: 15px;
        }

        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            transition: background-color 0.2s;
        }

        .test-button:hover {
            background: #0056b3;
        }

        .results-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .results-section h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .result-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .result-item h4 {
            margin-top: 0;
            color: #007bff;
        }

        .result-payload {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 10px;
            word-break: break-all;
        }

        .clear-results {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .clear-results:hover {
            background: #c82333;
        }

        .instructions {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .instructions h3 {
            margin-top: 0;
            color: #1976d2;
        }

        .code-example {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
            word-break: break-all;
        }

        .llm-config-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .llm-config-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
        }

        .config-item label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }

        .config-item input, .config-item select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .config-item input:focus, .config-item select:focus {
            outline: none;
            border-color: #007bff;
        }

        .preset-buttons h4 {
            margin-bottom: 10px;
            color: #666;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }

        .preset-btn {
            padding: 6px 10px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: #e9ecef;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß™ Workflow Chat Test Page</h1>
        <p>Test the workflow chat prototype with different scenarios</p>
    </div>

    <div class="instructions">
        <h3>üìã How to Use</h3>
        <p>Click any test scenario below to launch the workflow chat with pre-configured parameters. The chat will guide you through completing the workflow, then redirect back here with the results.</p>
        <p><strong>Note:</strong> Configure your LLM provider below and ensure it's running/accessible.</p>
    </div>

    <div class="llm-config-section">
        <h3>ü§ñ LLM Configuration</h3>
        <div class="config-grid">
            <div class="config-item">
                <label>Provider:</label>
                <select id="llm-provider">
                    <option value="lmStudio">LMStudio</option>
                    <option value="openRouter">OpenRouter</option>
                </select>
            </div>

            <div class="config-item lmStudio-config">
                <label>LMStudio Endpoint:</label>
                <input type="text" id="lmstudio-endpoint" value="http://localhost:1234" placeholder="http://localhost:1234">
            </div>

            <div class="config-item lmStudio-config">
                <label>Model:</label>
                <input type="text" id="lmstudio-model" value="qwen/qwen3-4b-thinking-2507" placeholder="qwen/qwen3-4b-thinking-2507">
            </div>

            <div class="config-item openRouter-config" style="display: none;">
                <label>API Key:</label>
                <input type="password" id="openrouter-key" placeholder="sk-or-v1-...">
            </div>

            <div class="config-item openRouter-config" style="display: none;">
                <label>Model:</label>
                <input type="text" id="openrouter-model" placeholder="openai/gpt-4o">
            </div>
        </div>

        <div class="preset-buttons">
            <h4>Quick Setup - Popular Models:</h4>
            <div class="preset-grid" id="lmstudio-presets">
                <button class="preset-btn" onclick="setModel('lmStudio', 'qwen/qwen3-4b-thinking-2507')">Qwen 3 4B Thinking</button>
                <button class="preset-btn" onclick="setModel('lmStudio', 'meta-llama-3.1-8b-instruct')">Llama 3.1 8B</button>
                <button class="preset-btn" onclick="setModel('lmStudio', 'microsoft/wizardlm-2-8x22b')">WizardLM 2 8x22B</button>
                <button class="preset-btn" onclick="setModel('lmStudio', 'mistralai/mistral-7b-instruct-v0.3')">Mistral 7B</button>
            </div>
            <div class="preset-grid" id="openrouter-presets" style="display: none;">
                <button class="preset-btn" onclick="setModel('openRouter', 'openai/gpt-4o')">GPT-4o</button>
                <button class="preset-btn" onclick="setModel('openRouter', 'anthropic/claude-3.5-sonnet')">Claude 3.5 Sonnet</button>
                <button class="preset-btn" onclick="setModel('openRouter', 'meta-llama/llama-3.1-70b-instruct')">Llama 3.1 70B</button>
                <button class="preset-btn" onclick="setModel('openRouter', 'google/gemini-pro-1.5')">Gemini Pro 1.5</button>
            </div>
        </div>
    </div>

    <div class="test-scenarios">
        <div class="scenario-card">
            <h3>üç≥ Recipe Creation</h3>
            <p>Create a new recipe by providing ingredients and instructions through interactive chat.</p>
            <button class="test-button" onclick="launchTest('recipe')">Launch Recipe Workflow</button>
        </div>

        <div class="scenario-card">
            <h3>üõí Shopping List</h3>
            <p>Generate a shopping list based on meal planning requirements.</p>
            <button class="test-button" onclick="launchTest('shopping')">Launch Shopping Workflow</button>
        </div>

        <div class="scenario-card">
            <h3>üìä Inventory Update</h3>
            <p>Update inventory quantities by specifying items and amounts.</p>
            <button class="test-button" onclick="launchTest('inventory')">Launch Inventory Workflow</button>
        </div>

        <div class="scenario-card">
            <h3>üéØ Custom Workflow</h3>
            <p>Test with custom prompt and schema parameters.</p>
            <button class="test-button" onclick="launchTest('custom')">Launch Custom Workflow</button>
        </div>
    </div>

    <div class="results-section">
        <h2>üìÑ Completed Workflows</h2>
        <p>Results from completed workflow chats will appear here:</p>
        <div id="results-container">
            <!-- Results will be populated here -->
        </div>
        <button class="clear-results" onclick="clearResults()">Clear Results</button>
    </div>

    <script>
        // Test scenarios configuration
        const testScenarios = {
            recipe: {
                prompt: "Create a new recipe. Ask the user for the recipe name, ingredients with quantities and units, and cooking instructions. Make sure ingredients are in lowercase and use standard grocery store names.",
                schema: {
                    type: "object",
                    properties: {
                        name: { type: "string" },
                        ingredients: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    name: { type: "string" },
                                    quantity: { type: "number" },
                                    unit: { type: "string" }
                                },
                                required: ["name", "quantity", "unit"]
                            }
                        },
                        method: {
                            type: "array",
                            items: { type: "string" }
                        }
                    },
                    required: ["name", "ingredients"]
                }
            },

            shopping: {
                prompt: "Generate a shopping list. Ask the user what meals they plan to cook and what ingredients they already have. Create a list of items they need to buy with quantities.",
                schema: {
                    type: "object",
                    properties: {
                        items: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    name: { type: "string" },
                                    quantity: { type: "number" },
                                    unit: { type: "string" }
                                },
                                required: ["name", "quantity", "unit"]
                            }
                        },
                        notes: { type: "string" }
                    },
                    required: ["items"]
                }
            },

            inventory: {
                prompt: "Update inventory quantities. Ask the user which items they want to add or update in their inventory, along with the quantities and units.",
                schema: {
                    type: "object",
                    properties: {
                        updates: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    item: { type: "string" },
                                    quantity: { type: "number" },
                                    unit: { type: "string" },
                                    action: { type: "string", enum: ["add", "set"] }
                                },
                                required: ["item", "quantity", "unit", "action"]
                            }
                        }
                    },
                    required: ["updates"]
                }
            },

            custom: {
                prompt: "Help the user complete any task they describe. Ask clarifying questions as needed and provide a structured result.",
                schema: {
                    type: "object",
                    properties: {
                        task: { type: "string" },
                        result: { type: "string" },
                        details: { type: "object" }
                    },
                    required: ["task", "result"]
                }
            }
        };

        function launchTest(scenario) {
            const config = testScenarios[scenario];
            if (!config) {
                alert('Unknown test scenario');
                return;
            }

            // Get current LLM configuration
            const llmConfig = {
                provider: document.getElementById('llm-provider').value,
                lmStudioEndpoint: document.getElementById('lmstudio-endpoint').value,
                lmStudioModel: document.getElementById('lmstudio-model').value,
                openRouterApiKey: document.getElementById('openrouter-key').value,
                openRouterModel: document.getElementById('openrouter-model').value
            };

            // Encode parameters as base64
            const params = new URLSearchParams({
                prompt: btoa(config.prompt),
                schema: btoa(JSON.stringify(config.schema)),
                returnUrl: window.location.href,
                llmConfig: btoa(JSON.stringify(llmConfig))
            });

            // Launch workflow chat
            const workflowUrl = `index.html?${params}`;
            window.location.href = workflowUrl;
        }

        function clearResults() {
            localStorage.removeItem('workflow-test-results');
            document.getElementById('results-container').innerHTML = '';
        }

        // Check for workflow results on page load
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const payload = urlParams.get('payload');

            if (payload) {
                try {
                    const decodedPayload = JSON.parse(atob(payload));
                    saveResult(decodedPayload);

                    // Clean URL
                    const cleanUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                } catch (error) {
                    console.error('Error processing workflow result:', error);
                    alert('Error processing workflow result: ' + error.message);
                }
            }

            // Load and display saved results
            loadResults();
        });

        function saveResult(payload) {
            const results = JSON.parse(localStorage.getItem('workflow-test-results') || '[]');
            results.unshift({
                timestamp: new Date().toISOString(),
                payload: payload
            });

            // Keep only last 10 results
            if (results.length > 10) {
                results.splice(10);
            }

            localStorage.setItem('workflow-test-results', JSON.stringify(results));
        }

        function loadResults() {
            const results = JSON.parse(localStorage.getItem('workflow-test-results') || '[]');
            const container = document.getElementById('results-container');

            if (results.length === 0) {
                container.innerHTML = '<p><em>No completed workflows yet. Try launching a test scenario!</em></p>';
                return;
            }

            container.innerHTML = results.map((result, index) => `
                <div class="result-item">
                    <h4>Workflow ${index + 1}</h4>
                    <small>${new Date(result.timestamp).toLocaleString()}</small>
                    <div class="result-payload">${JSON.stringify(result.payload, null, 2)}</div>
                </div>
            `).join('');
        }

        // LLM Provider switching
        document.getElementById('llm-provider').addEventListener('change', function(e) {
            const provider = e.target.value;
            const lmStudioElements = document.querySelectorAll('.lmStudio-config');
            const openRouterElements = document.querySelectorAll('.openRouter-config');
            const lmStudioPresets = document.getElementById('lmstudio-presets');
            const openRouterPresets = document.getElementById('openrouter-presets');

            if (provider === 'lmStudio') {
                lmStudioElements.forEach(el => el.style.display = 'block');
                openRouterElements.forEach(el => el.style.display = 'none');
                lmStudioPresets.style.display = 'grid';
                openRouterPresets.style.display = 'none';
            } else {
                lmStudioElements.forEach(el => el.style.display = 'none');
                openRouterElements.forEach(el => el.style.display = 'block');
                lmStudioPresets.style.display = 'none';
                openRouterPresets.style.display = 'grid';
            }
        });

        // Model selection function
        function setModel(provider, model) {
            if (provider === 'lmStudio') {
                document.getElementById('lmstudio-model').value = model;
            } else {
                document.getElementById('openrouter-model').value = model;
            }
        }

        // Load saved configuration on page load
        window.addEventListener('load', function() {
            // Load saved LLM config
            const savedConfig = localStorage.getItem('workflow-test-llm-config');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('llm-provider').value = config.provider || 'lmStudio';
                document.getElementById('lmstudio-endpoint').value = config.lmStudioEndpoint || 'http://localhost:1234';
                document.getElementById('lmstudio-model').value = config.lmStudioModel || 'qwen/qwen3-4b-thinking-2507';
                document.getElementById('openrouter-key').value = config.openRouterApiKey || '';
                document.getElementById('openrouter-model').value = config.openRouterModel || 'openai/gpt-4o';

                // Trigger provider change to show/hide appropriate fields
                document.getElementById('llm-provider').dispatchEvent(new Event('change'));
            }

            // Check for workflow results
            const urlParams = new URLSearchParams(window.location.search);
            const payload = urlParams.get('payload');

            if (payload) {
                try {
                    const decodedPayload = JSON.parse(atob(payload));
                    saveResult(decodedPayload);

                    // Clean URL
                    const cleanUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                } catch (error) {
                    console.error('Error processing workflow result:', error);
                    alert('Error processing workflow result: ' + error.message);
                }
            }

            // Load and display saved results
            loadResults();
        });

        // Save configuration when inputs change
        ['llm-provider', 'lmstudio-endpoint', 'lmstudio-model', 'openrouter-key', 'openrouter-model'].forEach(id => {
            document.getElementById(id).addEventListener('input', saveConfig);
        });

        function saveConfig() {
            const config = {
                provider: document.getElementById('llm-provider').value,
                lmStudioEndpoint: document.getElementById('lmstudio-endpoint').value,
                lmStudioModel: document.getElementById('lmstudio-model').value,
                openRouterApiKey: document.getElementById('openrouter-key').value,
                openRouterModel: document.getElementById('openrouter-model').value
            };
            localStorage.setItem('workflow-test-llm-config', JSON.stringify(config));
        }

        // Utility function to show URL encoding example
        function showUrlExample(scenario) {
            const config = testScenarios[scenario];
            const params = new URLSearchParams({
                prompt: btoa(config.prompt),
                schema: btoa(JSON.stringify(config.schema)),
                returnUrl: window.location.href
            });

            const exampleDiv = document.createElement('div');
            exampleDiv.className = 'code-example';
            exampleDiv.textContent = `workflow-chat/index.html?${params}`;

            const existing = document.querySelector('.code-example');
            if (existing) {
                existing.replaceWith(exampleDiv);
            } else {
                document.querySelector('.instructions').appendChild(exampleDiv);
            }
        }
    </script>
</body>
</html>
